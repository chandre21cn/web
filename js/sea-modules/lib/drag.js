/**
 * Created by Chandre on 14-10-21.
 *
 * http://dragsort.codeplex.com/
 *
 * http://www.oschina.net/code/snippet_82493_22787
 */
define("lib/drag",["$"],function(a){var b=jQuery=a("$");(function(i){var c=false;var g=null;var d=null;var f=null;var h=null;var e=false;var j=0;i.fn.jsmartdrag=function(o){var m=this;var p={sourceClass:"jsmartdrag-source",sourceHoverClass:"jsmartdrag-source-hover",cursorHoverClass:"jsmartdrag-cursor-hover",targetHoverClass:"jsmartdrag-target-hover",canSelect:false,target:".target",onDrag:function(){},afterDrag:function(s,r,q){}};o=i.extend(p,o);this.each(function(){i("body").css("-moz-user-select","none");if(!p.canSeletct){document.ondragstart=function(){return false};document.onselectstart=function(){return false}}if(o.target!=null){d=i(o.target)}i(this).addClass(o.sourceClass);i(this).mousedown(function(){f=i(this);c=true;i(this).addClass(o.sourceHoverClass);g=i(this).clone();g.attr("id","cloneDiv");g.addClass(o.sourceHoverClass);j=i("html,body").scrollTop()});i(document).mousemove(function(s){if(c){if(i("#cloneDiv").length<=0){i("body").append(g)}var t={x1:0,x2:0,y1:0,y2:0};var r=0;var q=0;if(i.browser.msie){r=s.clientX;q=s.clientY+j}else{r=s.pageX;q=s.pageY}t.x1=r-g.innerWidth()/2;t.y1=q-g.innerHeight()/2;g.css({left:t.x1+"px",top:t.y1+"px",position:"absolute"});if(d.length>0){d.each(function(){if(l(g,i(this))){i(this).addClass(o.targetHoverClass)}else{i(this).removeClass(o.targetHoverClass)}})}o.onDrag()}});i(document).mouseup(function(){if(c){c=false;if(g!=null&&d!=null){if(i(i("[class$='jsmartdrag-target-hover']")[0]).length>0){h=i(i("[class$='jsmartdrag-target-hover']")[0]);e=true}o.afterDrag(e,f,h);g.remove();g.removeClass(o.cursorHoverClass);i("[class$='jsmartdrag-target-hover']").each(function(){i(this).removeClass(o.targetHoverClass)});f.removeClass(o.sourceHoverClass);f=null;if(e==true){h.removeClass(o.targetHoverClass);h=null;e=false}}}})});function l(t,x){var w=t.offset().left;var r=t.offset().top;var q=t.offset().left+g.innerWidth();var u=t.offset().top+g.innerHeight();var A=x.offset().left;var C=x.offset().top;var v=x.offset().left+d.innerWidth();var D=x.offset().top+d.innerHeight();var B=k(w,A);var z=k(r,C);var s=n(q,q);var y=n(u,D);if(B<v&&z<D&&s>A&&y>C){i("[class$='jsmartdrag-target-hover']").each(function(){i(this).removeClass("jsmartdrag-target-hover")});return true}else{return false}}function k(r,q){if(r>q){return r}else{return q}}function n(r,q){if(r>q){return q}else{return r}}return m}})(jQuery);(function(c){c.fn.dragsort=function(f){if(f=="destroy"){c(this.selector).trigger("dragsort-uninit");return}var g=c.extend({},c.fn.dragsort.defaults,f);var e=[];var h=null,d=null;this.each(function(k,j){if(c(j).is("table")&&c(j).children().size()==1&&c(j).children().is("tbody")){j=c(j).children().get(0)}var l={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:j,init:function(){g.tagName=c(this.container).children().size()==0?"li":c(this.container).children().get(0).tagName.toLowerCase();if(g.itemSelector==""){g.itemSelector=g.tagName}if(g.dragSelector==""){g.dragSelector=g.tagName}if(g.placeHolderTemplate==""){g.placeHolderTemplate="<"+g.tagName+"> </"+g.tagName+">"}c(this.container).attr("data-listidx",k).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit);this.styleDragHandlers(true)},uninit:function(){var i=e[c(this).attr("data-listidx")];c(i.container).unbind("mousedown",i.grabItem).unbind("dragsort-uninit");i.styleDragHandlers(false)},getItems:function(){return c(this.container).children(g.itemSelector)},styleDragHandlers:function(i){this.getItems().map(function(){return c(this).is(g.dragSelector)?this:c(this).find(g.dragSelector).get()}).css("cursor",i?"pointer":"")},grabItem:function(r){var q=e[c(this).attr("data-listidx")];var o=c(r.target).closest("[data-listidx] > "+g.tagName).get(0);var i=q.getItems().filter(function(){return this==o}).size()>0;if(r.which!=1||c(r.target).is(g.dragSelectorExclude)||c(r.target).closest(g.dragSelectorExclude).size()>0||!i){return}r.preventDefault();var p=r.target;while(!c(p).is(g.dragSelector)){if(p==this){return}p=p.parentNode}c(p).attr("data-cursor",c(p).css("cursor"));c(p).css("cursor","move");var n=this;var m=function(){q.dragStart.call(n,r);c(q.container).unbind("mousemove",m)};c(q.container).mousemove(m).mouseup(function(){c(q.container).unbind("mousemove",m);c(p).css("cursor",c(p).attr("data-cursor"))})},dragStart:function(q){if(h!=null&&h.draggedItem!=null){h.dropItem()}h=e[c(this).attr("data-listidx")];h.draggedItem=c(q.target).closest("[data-listidx] > "+g.tagName);h.draggedItem.attr("data-origpos",c(this).attr("data-listidx")+"-"+c(h.container).children().index(h.draggedItem));var m=parseInt(h.draggedItem.css("marginTop"));var s=parseInt(h.draggedItem.css("marginLeft"));h.offset=h.draggedItem.offset();h.offset.top=q.pageY-h.offset.top+(isNaN(m)?0:m)-1;h.offset.left=q.pageX-h.offset.left+(isNaN(s)?0:s)-1;if(!g.dragBetween){var p=c(h.container).outerHeight()==0?Math.max(1,Math.round(0.5+h.getItems().size()*h.draggedItem.outerWidth()/c(h.container).outerWidth()))*h.draggedItem.outerHeight():c(h.container).outerHeight();h.offsetLimit=c(h.container).offset();h.offsetLimit.right=h.offsetLimit.left+c(h.container).outerWidth()-h.draggedItem.outerWidth();h.offsetLimit.bottom=h.offsetLimit.top+p-h.draggedItem.outerHeight()}var n=h.draggedItem.height();var i=h.draggedItem.width();if(g.tagName=="tr"){h.draggedItem.children().each(function(){c(this).width(c(this).width())});h.placeHolderItem=h.draggedItem.clone().attr("data-placeholder",true);h.draggedItem.after(h.placeHolderItem);h.placeHolderItem.children().each(function(){c(this).css({borderWidth:0,width:c(this).width()+1,height:c(this).height()+1}).html(" ")})}else{h.draggedItem.after(g.placeHolderTemplate);h.placeHolderItem=h.draggedItem.next().css({height:n,width:i}).attr("data-placeholder",true)}if(g.tagName=="td"){var o=h.draggedItem.closest("table").get(0);c("<table id='"+o.id+"' style='border-width: 0px;' class='dragSortItem "+o.className+"'><tr></tr></table>").appendTo("body").children().append(h.draggedItem)}var r=h.draggedItem.attr("style");h.draggedItem.attr("data-origstyle",r?r:"");h.draggedItem.css({position:"absolute",opacity:0.8,"z-index":999,height:n,width:i});h.scroll={moveX:0,moveY:0,maxX:c(document).width()-c(window).width(),maxY:c(document).height()-c(window).height()};h.scroll.scrollY=window.setInterval(function(){if(g.scrollContainer!=window){c(g.scrollContainer).scrollTop(c(g.scrollContainer).scrollTop()+h.scroll.moveY);return}var u=c(g.scrollContainer).scrollTop();if(h.scroll.moveY>0&&u<h.scroll.maxY||h.scroll.moveY<0&&u>0){c(g.scrollContainer).scrollTop(u+h.scroll.moveY);h.draggedItem.css("top",h.draggedItem.offset().top+h.scroll.moveY+1)}},10);h.scroll.scrollX=window.setInterval(function(){if(g.scrollContainer!=window){c(g.scrollContainer).scrollLeft(c(g.scrollContainer).scrollLeft()+h.scroll.moveX);return}var t=c(g.scrollContainer).scrollLeft();if(h.scroll.moveX>0&&t<h.scroll.maxX||h.scroll.moveX<0&&t>0){c(g.scrollContainer).scrollLeft(t+h.scroll.moveX);h.draggedItem.css("left",h.draggedItem.offset().left+h.scroll.moveX+1)}},10);c(e).each(function(u,t){t.createDropTargets();t.buildPositionTable()});h.setPos(q.pageX,q.pageY);c(document).bind("mousemove",h.swapItems);c(document).bind("mouseup",h.dropItem);if(g.scrollContainer!=window){c(window).bind("wheel",h.wheel)}},setPos:function(m,r){var p=r-this.offset.top;var o=m-this.offset.left;if(!g.dragBetween){p=Math.min(this.offsetLimit.bottom,Math.max(p,this.offsetLimit.top));o=Math.min(this.offsetLimit.right,Math.max(o,this.offsetLimit.left))}var n=this.draggedItem.offsetParent().not("body").offset();if(n!=null){p-=n.top;o-=n.left}if(g.scrollContainer==window){r-=c(window).scrollTop();m-=c(window).scrollLeft();r=Math.max(0,r-c(window).height()+5)+Math.min(0,r-5);m=Math.max(0,m-c(window).width()+5)+Math.min(0,m-5)}else{var i=c(g.scrollContainer);var q=i.offset();r=Math.max(0,r-i.height()-q.top)+Math.min(0,r-q.top);m=Math.max(0,m-i.width()-q.left)+Math.min(0,m-q.left)}h.scroll.moveX=m==0?0:m*g.scrollSpeed/Math.abs(m);h.scroll.moveY=r==0?0:r*g.scrollSpeed/Math.abs(r);this.draggedItem.css({top:p,left:o})},wheel:function(n){if(h&&g.scrollContainer!=window){var i=c(g.scrollContainer);var o=i.offset();n=n.originalEvent;if(n.clientX>o.left&&n.clientX<o.left+i.width()&&n.clientY>o.top&&n.clientY<o.top+i.height()){var m=(n.deltaMode==0?1:10)*n.deltaY;i.scrollTop(i.scrollTop()+m);n.preventDefault()}}},buildPositionTable:function(){var i=[];this.getItems().not([h.draggedItem[0],h.placeHolderItem[0]]).each(function(m){var n=c(this).offset();n.right=n.left+c(this).outerWidth();n.bottom=n.top+c(this).outerHeight();n.elm=this;i[m]=n});this.pos=i},dropItem:function(){if(h.draggedItem==null){return}var n=h.draggedItem.attr("data-origstyle");h.draggedItem.attr("style",n);if(n==""){h.draggedItem.removeAttr("style")}h.draggedItem.removeAttr("data-origstyle");h.styleDragHandlers(true);h.placeHolderItem.before(h.draggedItem);h.placeHolderItem.remove();c("[data-droptarget], .dragSortItem").remove();window.clearInterval(h.scroll.scrollY);window.clearInterval(h.scroll.scrollX);if(h.draggedItem.attr("data-origpos")!=c(e).index(h)+"-"+c(h.container).children().index(h.draggedItem)){if(g.dragEnd.apply(h.draggedItem)==false){var m=h.draggedItem.attr("data-origpos").split("-");var i=c(e[m[0]].container).children().not(h.draggedItem).eq(m[1]);if(i.size()>0){i.before(h.draggedItem)}else{if(m[1]==0){c(e[m[0]].container).prepend(h.draggedItem)}else{c(e[m[0]].container).append(h.draggedItem)}}}}h.draggedItem.removeAttr("data-origpos");h.draggedItem=null;c(document).unbind("mousemove",h.swapItems);c(document).unbind("mouseup",h.dropItem);if(g.scrollContainer!=window){c(window).unbind("wheel",h.wheel)}return false},swapItems:function(r){if(h.draggedItem==null){return false}h.setPos(r.pageX,r.pageY);var q=h.findPos(r.pageX,r.pageY);var p=h;for(var n=0;q==-1&&g.dragBetween&&n<e.length;n++){q=e[n].findPos(r.pageX,r.pageY);p=e[n]}if(q==-1){return false}var m=function(){return c(p.container).children().not(p.draggedItem)};var o=m().not(g.itemSelector).each(function(s){this.idx=m().index(this)});if(d==null||d.top>h.draggedItem.offset().top||d.left>h.draggedItem.offset().left){c(p.pos[q].elm).before(h.placeHolderItem)}else{c(p.pos[q].elm).after(h.placeHolderItem)}o.each(function(){var i=m().eq(this.idx).get(0);if(this!=i&&m().index(this)<this.idx){c(this).insertAfter(i)}else{if(this!=i){c(this).insertBefore(i)}}});c(e).each(function(t,s){s.createDropTargets();s.buildPositionTable()});d=h.draggedItem.offset();return false},findPos:function(m,o){for(var n=0;n<this.pos.length;n++){if(this.pos[n].left<m&&this.pos[n].right>m&&this.pos[n].top<o&&this.pos[n].bottom>o){return n}}return -1},createDropTargets:function(){if(!g.dragBetween){return}c(e).each(function(){var m=c(this.container).find("[data-placeholder]");var i=c(this.container).find("[data-droptarget]");if(m.size()>0&&i.size()>0){i.remove()}else{if(m.size()==0&&i.size()==0){if(g.tagName=="td"){c(g.placeHolderTemplate).attr("data-droptarget",true).appendTo(this.container)}else{c(this.container).append(h.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget",true))}h.placeHolderItem.attr("data-placeholder",true)}}})}};l.init();e.push(l)});return this};c.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:false,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}})(jQuery)});